## day7,8,9

### ä»€ä¹ˆæ˜¯ Express

å¯ä»¥ç†è§£æˆæ˜¯ä¸€ç§ Nodejs çš„å†æŠ½è±¡å’Œå°è£…ï¼Œå¤§å¤§ç®€çº¦äº† Nodejs çš„ä¹¦å†™ã€‚

### REST æ¶æ„

### å¦‚ä½•ç†è§£ HTTP è¯·æ±‚

å¯¹äºä¸€ä¸ª URL: www.example.com/tours

å…¶ä¸­æ•´ä¸ªç½‘å€æ˜¯ä¸€ä¸ª URLï¼Œè€Œ/tours å¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ª endpoint

ä½†æ˜¯å¯¹äºè¿™ä¸ªç›®æ ‡ä¸Šçš„èµ„æºï¼Œæˆ‘ä»¬é‡‡å–çš„é€»è¾‘å¯èƒ½æ˜¯å¢åˆ æ”¹æŸ¥å››ç§ï¼Œéœ€è¦è®¿é—®è¿™ä¸ª URL å®ç°å››ç§ä¸åŒçš„é€»è¾‘ï¼Œå°±éœ€è¦é€šè¿‡è®¾ç½®ä¸åŒ HTTP è¯·æ±‚ã€‚

HTTP è¯·æ±‚é€šå¸¸å¯ä»¥åˆ†æˆä¸‹é¢å‡ ç§ç±»å‹ï¼š

POST: é€šå¸¸æ˜¯ç”¨æ¥åˆ›å»ºï¼Œé€šå¸¸æœåŠ¡å™¨å¸Œæœ›è¿™ç§æ˜¯å®¢æˆ·ç«¯çš„è¯·æ±‚å’Œæ•°æ®åŒæ—¶å‘è¿‡æ¥

GETï¼šé€šå¸¸æ˜¯å®¢æˆ·ç«¯è¯»å–æ•°æ®ï¼ŒæœåŠ¡å™¨å°†æ•°æ®å‘é€å‡ºå»

PUT å’Œ PATCH éƒ½æ˜¯ä¸ºäº†æ›´æ–°æ•°æ®ï¼Œæ–¹å¼å’Œ POST ç±»ä¼¼ï¼Œä½†æ˜¯ç›®çš„ä¸åŒã€‚å¹¶ä¸” PUT è¦æ±‚æ˜¯æ•´ä¸ªå¯¹è±¡å‘è¿‡æ¥ï¼Œè€Œ PATCH æ˜¯å¸Œæœ›åªå‘é€æ›´æ–°çš„è¿‡æ¥ã€‚

DELETEï¼šä¸ºäº†åˆ é™¤æ•°æ®

### æ•´ç†æ‰€æœ‰çš„è·¯ç”±

é€šè¿‡å®šä¹‰å¤šä¸ªæ–¹æ³•â€”â€”ç»™ä¸åŒçš„ http è¯·æ±‚å¯¹åº”çš„å›è°ƒå‡½æ•°å‘½å

```
const getTour = (req,res) => {
  const id = req.params();
  const find_id = req.params.id * 1;
  const tour = tours.find((el) => el.id === find_id);
  if (!tour) {
    res.status(404).json({
      status: "fail",
      message: "invalid request: excessive id.",
    });
  } else {
    res.status(200).json({
      status: "success",
      // data: tours[req.params.id]
      data: tour,
    });
  }
}

app.route('/api/v1/tours/id').get(getTour).patch(updateTour).delete(deleteTour);

```

```
const getALLTours = (err,data) => {

}

app.route('/api/v1/tours').get(getALLTours).post(createTour);

```

### ä¸­é—´ä»¶

æŒ‰ç…§ä¸­é—´ä»¶çš„é¡ºåºï¼Œä¾æ¬¡æ‰§è¡Œï¼Œå¦‚æœä¸è°ƒç”¨ next()ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œåé¢çš„ä¸­é—´ä»¶ã€‚

express.json() æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨æ¥è§£æ json æ•°æ®ï¼Œç„¶åå°†è§£æåçš„æ•°æ®æ”¾åˆ° req.body ä¸­ã€‚å’Œè‡ªå®šä¹‰ä¸­é—´ä»¶ä¸€æ ·ï¼Œä¹Ÿæ˜¯é€šè¿‡ next() æ¥è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚å®ƒçš„

next() æ˜¯åœ¨è§£æå®Œæ•°æ®åè°ƒç”¨çš„ï¼Œæ‰€ä»¥åé¢çš„ä¸­é—´ä»¶æ‰èƒ½æ‹¿åˆ°è§£æåçš„æ•°æ®ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨è‡ªå®šä¹‰ä¸­é—´ä»¶ä¸­ä½¿ç”¨ req.bodyï¼Œå°±éœ€è¦åœ¨ express.json() ä¹‹åã€‚
å½“æ‰§è¡Œåˆ° end ä¹‹åå°±ä¸ä¼šå†ç»§ç»­æ‰§è¡Œåé¢çš„è¯·æ±‚ï¼Œå› æ­¤ä¸­é—´ä»¶ä¹Ÿä¸ä¼šå¯¹åé¢çš„è¯·æ±‚èµ·ä½œç”¨ã€‚

```
app.use((req,res,next) => {
  console.log('hello from the middleware');
  next();
});
```

### æ—¥å¿—ä¸­é—´ä»¶ morgan

### è®¾ç½®å­è·¯ç”±

å°†ç¨‹åºè¿›è¡Œåˆ†ç¦»ï¼Œä¸ºæ¯ä¸€é¡¹èµ„æºè®¾ç½®å•ç‹¬çš„ Routerã€‚

`app.use("/api/v1/user", user_router)`è¿™è¡Œä»£ç çš„å«ä¹‰æ˜¯ï¼Œå½“ä½ çš„åº”ç”¨æ”¶åˆ°ä¸€ä¸ªä»¥`/api/v1/user`å¼€å¤´çš„è¯·æ±‚æ—¶ï¼Œå®ƒä¼šå°†è¯·æ±‚äº¤ç»™`user_router`æ¥å¤„ç†ã€‚

### å…³äºæ¨¡å—çš„åˆ†ç¦»

æ³¨æ„åœ¨å¯¼å‡ºæ¨¡å—çš„æ—¶å€™ exports.func = ()=>{} æ˜¯å¯ä»¥ç›´æ¥ä¿®æ”¹ module.exports çš„å±æ€§çš„ï¼Œå› ä¸º exports å°±æ˜¯ module.exports çš„ä¸€ä¸ªå¼•ç”¨ã€‚

ä½†æ˜¯å¦‚æœå¯¼å‡ºæ¨¡å—çš„æ—¶å€™ exports = funcsï¼Œfuncs æ˜¯ä¸€ç³»åˆ—çš„æ–¹æ³•ï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªç±»ã€‚é‚£ä¹ˆè¿™ä¸ªä¸ä¼šæ›´æ”¹ module.exportsã€‚

åœ¨ JavaScript ä¸­ï¼Œå½“ä½ å°†ä¸€ä¸ªå¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡æ—¶ï¼Œä½ å®é™…ä¸Šæ˜¯å°†è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™äº†è¿™ä¸ªå˜é‡ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å±æ€§ï¼ŒåŸå§‹å¯¹è±¡çš„ç›¸åº”å±æ€§ä¹Ÿä¼šè¢«ä¿®æ”¹ã€‚

ç„¶è€Œï¼Œå½“ä½ å°†ä¸€ä¸ªæ–°çš„å€¼ï¼ˆå¦‚ä¸€ä¸ªå‡½æ•°æˆ–ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼‰èµ‹å€¼ç»™è¿™ä¸ªå˜é‡æ—¶ï¼Œä½ å®é™…ä¸Šæ˜¯æ”¹å˜äº†è¿™ä¸ªå˜é‡çš„å¼•ç”¨ï¼Œä½¿å…¶æŒ‡å‘äº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚è¿™å¹¶ä¸ä¼šå½±å“åˆ°åŸå§‹å¯¹è±¡ã€‚

### router.param

`router.param()` æ–¹æ³•ç”¨äºåœ¨è·¯ç”±ä¸­é—´ä»¶ä¸­åŠ è½½å‚æ•°ã€‚è¿™ä¸ªæ–¹æ³•åœ¨åŠ è½½è·¯ç”±çº§ä¸­é—´ä»¶ä¹‹å‰æ‰§è¡Œï¼Œä¸”åªå¯¹åœ¨å½“å‰ router ä¸Šå®šä¹‰çš„ä¸­é—´ä»¶æœ‰æ•ˆã€‚åŒæ—¶å¯ä»¥é¿å…åœ¨æ¯ä¸ªè·¯ç”±ä¸­é—´ä»¶ä¸­é‡å¤å†™ç›¸åŒçš„ä»£ç ã€‚

`router.param()` åœ¨ Express.js ä¸­æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ä¸­é—´ä»¶ï¼Œå®ƒç”¨äºå¤„ç† URL å‚æ•°ã€‚å½“è·¯ç”±ä¸­åŒ…å«æŸä¸ªå‚æ•°æ—¶ï¼Œ`router.param()` ä¸­å®šä¹‰çš„ä¸­é—´ä»¶å°±ä¼šè¢«æ‰§è¡Œã€‚`router.param()` æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šå‚æ•°åç§°å’Œä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ã€‚å½“è·¯ç”±ä¸­åŒ…å«åŒ¹é…å‚æ•°åç§°çš„éƒ¨åˆ†æ—¶ï¼Œè¿™ä¸ªä¸­é—´ä»¶å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚åœ¨ä½ çš„ä»£ç ä¸­ï¼Œ`router.param('id', ...)` å®šä¹‰äº†ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè¿™ä¸ªä¸­é—´ä»¶ä¼šåœ¨ä»»ä½•åŒ…å« `:id` å‚æ•°çš„è·¯ç”±è¢«å¤„ç†ä¹‹å‰æ‰§è¡Œã€‚è¿™ä¸ªä¸­é—´ä»¶å‡½æ•°æ¥å—å››ä¸ªå‚æ•°ï¼š`req`ï¼ˆè¯·æ±‚å¯¹è±¡ï¼‰ã€`res`ï¼ˆå“åº”å¯¹è±¡ï¼‰ã€`next`ï¼ˆnext å‡½æ•°ï¼‰å’Œ `val`ï¼ˆURL å‚æ•°çš„å€¼ï¼‰ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä½ å¯ä»¥å¯¹ `val` è¿›è¡Œä»»ä½•éœ€è¦çš„å¤„ç†ï¼Œä¾‹å¦‚éªŒè¯æˆ–æ ¼å¼åŒ–ã€‚

å¦‚æœä½ åœ¨ä¸­é—´ä»¶å‡½æ•°ä¸­è°ƒç”¨äº† `next()`ï¼Œé‚£ä¹ˆæ§åˆ¶æƒä¼šè¢«ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è·¯ç”±å¤„ç†ç¨‹åºã€‚å¦‚æœä½ å‘é€äº†ä¸€ä¸ªå“åº”ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ `res.json()`ï¼‰ï¼Œé‚£ä¹ˆè¯·æ±‚-å“åº”å‘¨æœŸå°±ä¼šç»“æŸï¼Œä¸ä¼šå†æœ‰å…¶ä»–çš„ä¸­é—´ä»¶æˆ–è·¯ç”±å¤„ç†ç¨‹åºè¢«æ‰§è¡Œã€‚

æ¯”å¦‚è¯´åœ¨ tourController.js ä¸­ä¸ºäº†éªŒè¯æŸ¥è¯¢çš„ id æ˜¯å¦æ˜¯åˆç†çš„ï¼Œåœ¨å¾ˆå¤šä¸ªå‡½æ•°é‡Œé¢æˆ‘ä»¬éƒ½å†™äº†é‡å¤çš„ä»£ç ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨ tourRouter.js ä¸­ä½¿ç”¨ router.param()æ–¹æ³•æ¥é¿å…è¿™ç§é‡å¤çš„ä»£ç ï¼Œè¿™é‡Œåªéœ€è¦å®ç°ä¸€æ¬¡é€»è¾‘éªŒè¯ã€‚

```
router.param('id',(req,res,next,val) => {
  console.log(`Tour id is ${val}`);
  if (${req.params.id} > tours.length) {
    return res.status(404).json({
      status: 'fail',
      message: 'invalid request: excessive id.'
    });
  }
  next();
});
```

ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦ return?

ç›®çš„æ˜¯ä¸ºäº†ç»“æŸå½“å‰çš„ä¸­é—´ä»¶å‡½æ•°çš„æ‰§è¡Œã€‚å¦‚æœä½ ä¸ä½¿ç”¨ returnï¼Œé‚£ä¹ˆå³ä½¿ä½ å·²ç»å‘é€äº†å“åº”ï¼Œå½“å‰çš„ä¸­é—´ä»¶å‡½æ•°å¯èƒ½è¿˜ä¼šç»§ç»­æ‰§è¡Œï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯æˆ–è€…ä¸å¯é¢„æœŸçš„è¡Œä¸ºã€‚å³ä¼šç»§ç»­è°ƒç”¨ next()ã€‚ç„¶åå¯èƒ½åç»­çš„ä¸­é—´ä»¶å‡½æ•°ä¼šå†æ¬¡å‘é€å“åº”ï¼Œè¿™æ ·å°±ä¼šæŠ¥é”™ã€‚

ä¸€ä¸ªå°æŒ‘æˆ˜

```
exports.checkNew = ((req,res,next)=>{
  if(!req.body.name || !req.body.price){
    return res.status(400).json({
      status: 'fail',
      message: 'create fail: missing name or price'
    })
  }
  next();
})
```

è¿™ä¸¤ä¸ªåœ¨ä½¿ç”¨çš„åŒºåˆ«æ˜¯ï¼Œä¸€ä¸ªæ˜¯ url ä¸­è·¯ç”±ä¼šå­˜åœ¨ idï¼Œè¿™ç§æƒ…å†µå¯èƒ½æ˜¯è¦å¯¹æ‰€æœ‰å­˜åœ¨ id çš„è·¯ç”±è¿›è¡Œè¿™ä¸ªä¸­é—´ä»¶çš„æ“ä½œï¼Œè€Œå¦ä¸€ä¸ªæ˜¯é’ˆå¯¹æŒ‡å®šçš„æŸä¸€ä¸ªæ“ä½œæœ‰è¿™ä¸ªåˆ¤æ–­ï¼ˆæ¯”å¦‚è¯´åˆ›å»ºä¸€ä¸ªæ–°çš„ tour çš„æ—¶å€™ï¼‰å°±å¯ä»¥åœ¨ Router.post(checkNew,createTour)ã€‚ é€šè¿‡é“¾æ¥è¿™äº›ä¸­é—´ä»¶æ¥å®ç°ã€‚

### express.static

ç”¨æ¥è¿”å›é™æ€èµ„æºï¼Œè€Œä¸éœ€è¦ä½¿ç”¨è·¯ç”±æ¥è¿”å›è¿™äº›å†…å®¹ï¼Œæ¯”å¦‚è¯´å›¾ç‰‡ï¼Œcssï¼Œhtml ç­‰ç­‰ã€‚

### ç¯å¢ƒå˜é‡

ç¯å¢ƒå˜é‡å°±æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹ï¼Œå®ƒçš„å€¼æ˜¯ä¸åŒçš„ã€‚ä»–å¯ä»¥å®šä¹‰ä¸€ä¸ª node æ­£åœ¨ä½¿ç”¨çš„ç¯å¢ƒã€‚nodejs å…¶å®è®¾ç½®äº†å¾ˆå¤šçš„ç¯å¢ƒå˜é‡ã€‚

process.env å’Œ app.get('env') éƒ½æ˜¯åœ¨ Node.js å’Œ Express.js ä¸­è·å–ç¯å¢ƒå˜é‡çš„æ–¹å¼ï¼Œä½†å®ƒä»¬çš„ç”¨é€”å’Œè¡Œä¸ºæœ‰æ‰€ä¸åŒã€‚

process.env æ˜¯ Node.js æä¾›çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œç”¨äºè®¿é—®å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚ä½ å¯ä»¥ä½¿ç”¨ process.env æ¥è·å–æˆ–è®¾ç½®ä»»ä½•ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ process.env.DB_HOST æˆ– process.env.PORTã€‚

app.get('env') æ˜¯ Express.js æä¾›çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºè·å–å½“å‰ Express åº”ç”¨çš„è¿è¡Œç¯å¢ƒã€‚å¦‚æœä½ æ²¡æœ‰æ˜ç¡®è®¾ç½® NODE_ENV ç¯å¢ƒå˜é‡ï¼Œé‚£ä¹ˆ app.get('env') é»˜è®¤è¿”å› 'development'ã€‚

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œapp.get('env') å®é™…ä¸Šæ˜¯è¯»å– process.env.NODE_ENV çš„å€¼ã€‚ä½†æ˜¯ï¼Œå¦‚æœ process.env.NODE_ENV æ²¡æœ‰è¢«è®¾ç½®ï¼Œapp.get('env') ä¼šé»˜è®¤è¿”å› 'development'ï¼Œè€Œ process.env.NODE_ENV åˆ™ä¼šæ˜¯ undefinedã€‚

æ€»çš„æ¥è¯´ï¼Œprocess.env æ˜¯ä¸€ä¸ªæ›´é€šç”¨çš„å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥è®¿é—®æ‰€æœ‰çš„ç¯å¢ƒå˜é‡ï¼Œè€Œ app.get('env') æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„å·¥å…·ï¼Œä¸“é—¨ç”¨æ¥è·å– Express åº”ç”¨çš„è¿è¡Œç¯å¢ƒã€‚

å°† config.env ä¸­çš„ç¯å¢ƒå˜é‡é…ç½®åˆ° node ä¸­

```
shellä¸Šä¸‹è½½ä¾èµ–: npm i dotenv

åœ¨server.jsä¸­å¼•å…¥:
const dotenv = require('dotenv');
dotenv.config({path: './config.env'});
```

### å¸®åŠ©åˆ›å»ºæ›´å¥½çš„ç¼–ç¨‹è§„èŒƒ ESLint

```
npm i eslint prettier eslint-config-prettier eslint-plugin-prettier eslint-config-airbnb eslint-plugin-node eslint-plugin-import eslint-plugin-jsx-a11y eslint-plugin-react --save-dev

```

ç®€å•è§£é‡Š ğŸ‘† è¿™ä¸ª recipeï¼Œæš‚æ—¶ä¸è¦ç†è§£ï¼Œåªéœ€è¦æŒ‰ç…§é…ç½®æ¥åš

å…¶ä¸­ eslint-config-prettier æ˜¯ç”¨æ¥å…³é—­æ‰€æœ‰å’Œ prettier å†²çªçš„è§„åˆ™

eslint-plugin-prettier æ˜¯å°† prettier ä½œä¸º eslint çš„è§„åˆ™æ¥ä½¿ç”¨

eslint-config-airbub æ˜¯ airbub çš„ eslint è§„åˆ™

eslint-plugin-node æ˜¯ node çš„ eslint è§„åˆ™

eslint-plugin-import æ˜¯ import çš„ eslint è§„åˆ™

eslint-plugin-jsx-ally æ˜¯ jsx çš„ eslint è§„åˆ™

eslint-plugin-react æ˜¯ react çš„ eslint è§„åˆ™

è¿™æ ·çš„è®¾ç½®å¿…é¡»åœ¨æœ¬åœ°å®Œæˆï¼Œå¦‚æœæ˜¯å…¨å±€å¯èƒ½ä¼šä¸å·¥ä½œ
